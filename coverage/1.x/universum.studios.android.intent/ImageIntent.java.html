<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ImageIntent.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">universum.studios.android.intent</a> &gt; <span class="el_source">ImageIntent.java</span></div><h1>ImageIntent.java</h1><pre class="source lang-java linenums">/*
 * =================================================================================================
 *                             Copyright (C) 2016 Universum Studios
 * =================================================================================================
 *         Licensed under the Apache License, Version 2.0 or later (further &quot;License&quot; only).
 * -------------------------------------------------------------------------------------------------
 * You may use this file only in compliance with the License. More details and copy of this License
 * you may obtain at
 *
 * 		http://www.apache.org/licenses/LICENSE-2.0
 *
 * You can redistribute, modify or publish any part of the code written within this file but as it
 * is described in the License, the software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES or CONDITIONS OF ANY KIND.
 *
 * See the License for the specific language governing permissions and limitations under the License.
 * =================================================================================================
 */
package universum.studios.android.intent;

import android.app.Activity;
import android.app.Fragment;
import android.content.ContentResolver;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.support.annotation.IntRange;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.util.Log;

import java.io.File;
import java.io.IOException;

/**
 * A {@link ContentIntent} implementation providing API for building and starting of intents to obtain
 * or preview an image content.
 *
 * @author Martin Albedinsky
 */
<span class="fc" id="L47">public class ImageIntent extends ContentIntent&lt;ImageIntent&gt; {</span>

	/*
	 * Constants ===================================================================================
	 */

	/**
	 * Log TAG.
	 */
	private static final String TAG = &quot;ImageIntent&quot;;

	/**
	 * Flag to identify request code used to obtain image from gallery.
	 */
	public static final int REQUEST_CODE_GALLERY = 0x5001;

	/**
	 * Flag to identify request code used to obtain image using camera.
	 */
	public static final int REQUEST_CODE_CAMERA = 0x5002;

	/**
	 * Default format for image file name.
	 * &lt;p&gt;
	 * Constant value: &lt;b&gt;IMAGE_%s&lt;/b&gt;
	 */
	public static final String IMAGE_FILE_NAME_FORMAT = &quot;IMAGE_%s&quot;;

	/*
	 * Interface ===================================================================================
	 */

	/*
	 * Static members ==============================================================================
	 */

	/*
	 * Members =====================================================================================
	 */

	/**
	 * Camera intent handler.
	 */
	private ContentHandler mCameraHandler;

	/*
	 * Constructors ================================================================================
	 */

	/*
	 * Methods =====================================================================================
	 */

	/**
	 * Creates a new instance of Intent with {@link Intent#ACTION_GET_CONTENT} and {@link MimeType#IMAGE}
	 * MIME type that can be used to launch a gallery app (depends on user's choice) to pick one of
	 * available images.
	 *
	 * @return New gallery intent instance.
	 */
	@NonNull
	public static Intent createGalleryIntent() {
<span class="fc" id="L109">		return new Intent(Intent.ACTION_GET_CONTENT).setType(MimeType.IMAGE);</span>
	}

	/**
	 * Same as {@link #createCameraIntent(File)} with {@code null} for &lt;var&gt;outputFile&lt;/var&gt; parameter.
	 */
	@NonNull
	public static Intent createCameraIntent() {
<span class="fc" id="L117">		return createCameraIntent((Uri) null);</span>
	}

	/**
	 * Same as {@link #createCameraIntent(Uri)} with &lt;var&gt;outputUri&lt;/var&gt; created from the given
	 * &lt;var&gt;outputFile&lt;/var&gt; if not {@code nul}.
	 *
	 * @param outputFile The desired file used to crate the output Uri.
	 * @see #createCameraIntent()
	 */
	@NonNull
	public static Intent createCameraIntent(@Nullable final File outputFile) {
<span class="fc bfc" id="L129" title="All 2 branches covered.">		return createCameraIntent(outputFile == null ? null : Uri.fromFile(outputFile));</span>
	}

	/**
	 * Creates a new instance of Intent with {@link MediaStore#ACTION_IMAGE_CAPTURE} that can be used
	 * to launch a camera app to capture a single image.
	 *
	 * @param outputUri If not {@code null}, it will be attached to intent as {@link MediaStore#EXTRA_OUTPUT},
	 *                  so when the result is received in for example {@link Activity#onActivityResult(int, int, Intent)},
	 *                  the &lt;var&gt;outputUri&lt;/var&gt; will address to a file which contains the currently
	 *                  captured image.
	 * @return New camera intent instance.
	 * @see #createCameraIntent(File)
	 */
	@NonNull
	public static Intent createCameraIntent(@Nullable final Uri outputUri) {
<span class="fc" id="L145">		final Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">		if (outputUri != null) {</span>
<span class="fc" id="L147">			intent.putExtra(MediaStore.EXTRA_OUTPUT, outputUri);</span>
		}
<span class="fc" id="L149">		return intent;</span>
	}

	/**
	 * Same as {@link #createImageFile(String)} with &lt;var&gt;fileName&lt;/var&gt; in {@link #IMAGE_FILE_NAME_FORMAT}
	 * format with a string representation of the current time stamp obtained via {@link #createContentFileTimeStamp()}.
	 */
	@Nullable
	public static File createImageFile() {
<span class="fc" id="L158">		return createImageFile(String.format(IMAGE_FILE_NAME_FORMAT, createContentFileTimeStamp()));</span>
	}

	/**
	 * Same as {@link #createContentFile(String,  String)} with &lt;b&gt;.jpg&lt;/b&gt; suffix for the specified
	 * &lt;var&gt;fileName&lt;/var&gt; (if it does not contain any) and {@link Environment#DIRECTORY_PICTURES} as
	 * &lt;var&gt;externalDirectoryType&lt;/var&gt;.
	 *
	 * @param fileName The desired name for the image file.
	 * @see #createImageFile()
	 */
	@Nullable
	public static File createImageFile(@NonNull final String fileName) {
<span class="fc" id="L171">		return createContentFile(appendDefaultFileSuffixIfNotPresented(fileName, &quot;.jpg&quot;), Environment.DIRECTORY_PICTURES);</span>
	}

	/**
	 * Processes the given result &lt;var&gt;data&lt;/var&gt; intent to obtain a user's picked image.
	 * &lt;p&gt;
	 * &lt;b&gt;Note&lt;/b&gt;, that in case of {@link #REQUEST_CODE_CAMERA}, the captured photo's bitmap will be
	 * received only in quality of &quot;place holder&quot; image, not as full quality image. For full quality
	 * photo pass an instance of Uri to {@link #output(Uri)} and the bitmap of the captured
	 * photo will be stored on the specified uri.
	 *
	 * @param requestCode The request code from {@link Activity#onActivityResult(int, int, Intent)} or
	 *                    {@link Fragment#onActivityResult(int, int, Intent)}.
	 *                    Can be only one of {@link #REQUEST_CODE_CAMERA} or {@link #REQUEST_CODE_GALLERY}.
	 * @param resultCode  The result code from {@link Activity#onActivityResult(int, int, Intent)} or
	 *                    {@link Fragment#onActivityResult(int, int, Intent)}.
	 *                    If {@link Activity#RESULT_OK}, the passed &lt;var&gt;data&lt;/var&gt; will be processed,
	 *                    otherwise {@code null} will be returned.
	 * @param data        The data from {@link Activity#onActivityResult(int, int, Intent)} or
	 *                    {@link Fragment#onActivityResult(int, int, Intent)}.
	 * @param context     Current valid context.
	 * @param options     Image options to adjust obtained bitmap.
	 * @return Instance of Bitmap obtained from the given &lt;var&gt;data&lt;/var&gt; Intent.
	 */
	@Nullable
	@SuppressWarnings(&quot;deprecation&quot;)
	static Bitmap processResultIntent(
			final int requestCode,
			final int resultCode,
			@Nullable final Intent data,
			@NonNull final Context context,
			@Nullable final ImageOptions options
	) {
<span class="nc bnc" id="L204" title="All 4 branches missed.">		if (data == null || resultCode != Activity.RESULT_OK) {</span>
			// User canceled the intent or no data are available.
<span class="nc" id="L206">			return null;</span>
		}
<span class="nc bnc" id="L208" title="All 3 branches missed.">		switch (requestCode) {</span>
			case REQUEST_CODE_GALLERY:
<span class="nc" id="L210">				final Uri imageUri = data.getData();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (imageUri == null) {</span>
<span class="nc" id="L212">					return null;</span>
				}
<span class="nc" id="L214">				Bitmap galleryImage = null;</span>
<span class="nc" id="L215">				final ContentResolver contentResolver = context.getContentResolver();</span>
				try {
<span class="nc bnc" id="L217" title="All 2 branches missed.">					if (options == null) {</span>
<span class="nc" id="L218">						galleryImage = BitmapFactory.decodeStream(contentResolver.openInputStream(imageUri));</span>
					} else {
						// Get the dimensions of the returned bitmap.
<span class="nc" id="L221">						final BitmapFactory.Options bmOptions = new BitmapFactory.Options();</span>
<span class="nc" id="L222">						bmOptions.inJustDecodeBounds = true;</span>
<span class="nc" id="L223">						BitmapFactory.decodeStream(contentResolver.openInputStream(imageUri), null, bmOptions);</span>
<span class="nc" id="L224">						final int bmWidth = bmOptions.outWidth;</span>
<span class="nc" id="L225">						final int bmHeight = bmOptions.outHeight;</span>
						// Compute how much to scale the bitmap.
<span class="nc" id="L227">						final int scaleFactor = Math.min(bmWidth / options.width, bmHeight / options.height);</span>
						// Decode scaled bitmap.
<span class="nc" id="L229">						bmOptions.inJustDecodeBounds = false;</span>
<span class="nc" id="L230">						bmOptions.inSampleSize = scaleFactor;</span>
<span class="nc" id="L231">						bmOptions.inPurgeable = true;</span>
<span class="nc" id="L232">						galleryImage = BitmapFactory.decodeStream(contentResolver.openInputStream(imageUri), null, bmOptions);</span>
					}
<span class="nc" id="L234">				} catch (IOException e) {</span>
<span class="nc" id="L235">					Log.e(TAG, &quot;Unable to open stream to image content at uri(&quot; + imageUri + &quot;).&quot;, e);</span>
<span class="nc" id="L236">				}</span>
<span class="nc" id="L237">				return galleryImage;</span>
			case REQUEST_CODE_CAMERA:
<span class="nc" id="L239">				final Bundle extras = data.getExtras();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				final Bitmap cameraImage = extras == null ? null : (Bitmap) extras.get(&quot;data&quot;);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">				if (cameraImage != null &amp;&amp; options != null) {</span>
<span class="nc" id="L242">					return Bitmap.createScaledBitmap(cameraImage, options.width, options.height, false);</span>
				}
<span class="nc" id="L244">				return cameraImage;</span>
			default:
<span class="nc" id="L246">				return null;</span>
		}
	}

	/**
	 * Adds two default {@link ContentHandler}s. One for {@link #REQUEST_CODE_GALLERY} and second one
	 * for {@link #REQUEST_CODE_CAMERA}.
	 */
	@Override
	@SuppressWarnings(&quot;ConstantConditions&quot;)
	public ImageIntent withDefaultHandlers(@NonNull final Context context) {
<span class="fc" id="L257">		withHandlers(</span>
<span class="fc" id="L258">				onCreateGalleryHandler(context.getResources()),</span>
<span class="fc" id="L259">				mCameraHandler = onCreateCameraHandler(context.getResources())</span>
		);
<span class="fc bfc" id="L261" title="All 2 branches covered.">		if (mUri == null) {</span>
<span class="fc" id="L262">			mCameraHandler.intent.removeExtra(MediaStore.EXTRA_OUTPUT);</span>
		} else {
<span class="fc" id="L264">			mCameraHandler.intent.putExtra(MediaStore.EXTRA_OUTPUT, mUri);</span>
		}
<span class="fc" id="L266">		return this;</span>
	}

	/**
	 * Invoked from {@link #withDefaultHandlers(Context)} to create gallery intent handler.
	 * &lt;p&gt;
	 * This method may be override to create a handler with a localized name.
	 *
	 * @param resources Application resources.
	 * @return Content handler with gallery intent.
	 * @see #onCreateCameraHandler(Resources)
	 */
	@NonNull
	protected ContentHandler onCreateGalleryHandler(@NonNull final Resources resources) {
<span class="fc" id="L280">		return new ContentHandler(</span>
				&quot;Gallery&quot;,
<span class="fc" id="L282">				createGalleryIntent()</span>
<span class="fc" id="L283">		).requestCode(REQUEST_CODE_GALLERY);</span>
	}

	/**
	 * Invoked from {@link #withDefaultHandlers(Context)} to create camera intent handler.
	 * &lt;p&gt;
	 * This method may be override to create a handler with a localized name.
	 *
	 * @param resources Application resources.
	 * @return Content handler with camera intent.
	 * @see #onCreateGalleryHandler(Resources)
	 */
	@NonNull
	protected ContentHandler onCreateCameraHandler(@NonNull final Resources resources) {
<span class="fc" id="L297">		return new ContentHandler(</span>
				&quot;Camera&quot;,
<span class="fc" id="L299">				createCameraIntent()</span>
<span class="fc" id="L300">		).requestCode(REQUEST_CODE_CAMERA);</span>
	}

	/**
	 * If the passed &lt;var&gt;uri&lt;/var&gt; is not {@code null}, the current data (MIME) type will be set
	 * by default to {@link MimeType#IMAGE}.
	 */
	@Override
	public ImageIntent input(@Nullable Uri uri) {
<span class="fc" id="L309">		super.input(uri);</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">		if (uri != null) {</span>
<span class="fc" id="L311">			this.mDataType = MimeType.IMAGE;</span>
		}
<span class="fc" id="L313">		return this;</span>
	}

	/**
	 * Sets an output uri for an image to be captured by the camera.
	 *
	 * @param uri If not {@code null}, it will be attached to {@link ContentHandler}
	 *            holding intent with the {@link #REQUEST_CODE_CAMERA} request code, so when the camera
	 *            handler's item is selected within a &lt;b&gt;chooser dialog&lt;/b&gt; and user confirms his
	 *            captured photo, result for this action will be received in for example
	 *            {@link Activity#onActivityResult(int, int, Intent)}. The passed
	 *            &lt;var&gt;uri&lt;/var&gt; will then address to a file which contains the currently captured
	 *            image.
	 * @return This intent builder to allow methods chaining.
	 */
	@Override
	public ImageIntent output(@Nullable final Uri uri) {
<span class="fc" id="L330">		super.output(uri);</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">		if (mCameraHandler != null) {</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">			if (mUri == null) {</span>
<span class="fc" id="L333">				mCameraHandler.intent.removeExtra(MediaStore.EXTRA_OUTPUT);</span>
			} else {
<span class="fc" id="L335">				mCameraHandler.intent.putExtra(MediaStore.EXTRA_OUTPUT, mUri);</span>
			}
		}
<span class="fc" id="L338">		return this;</span>
	}

	/*
	 * Inner classes ===============================================================================
	 */

	/**
	 * Simple options for {@link #processResultIntent(int, int, Intent, Context, ImageOptions)}.
	 *
	 * @author Martin Albedinsky
	 */
<span class="pc" id="L350">	public static class ImageOptions {</span>

		/**
		 * Dimensions to which should be obtained image bitmap re-sized.
		 */
		int width, height;

		/**
		 * Sets the dimensions to which should be the obtained image bitmap re-sized.
		 *
		 * @param width  The desired image width to re-size to.
		 * @param height The desired image height to re-size to.
		 * @return This options instance.
		 */
		public ImageOptions inSize(@IntRange(from = 0, to = Integer.MAX_VALUE) final int width, @IntRange(from = 0, to = Integer.MAX_VALUE) final int height) {
<span class="nc" id="L365">			this.width = width;</span>
<span class="nc" id="L366">			this.height = height;</span>
<span class="nc" id="L367">			return this;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.3</div></body></html>